"use strict";var reloadSkinlib=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,requestSkinlibData();case 3:t=e.sent,$(".overlay").show(),renderSkinlib(t.items),updatePaginator($.skinlib.page,t.total_pages||1),updateUrlQueryString(),updateBreadCrumb(),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),showAjaxError(e.t0);case 14:case"end":return e.stop()}},e,this,[[0,11]])}));return function(){return e.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(a,i){function s(e,t){try{var n=o[e](t),r=n.value}catch(e){return void i(e)}if(!n.done)return Promise.resolve(r).then(function(e){s("next",e)},function(e){s("throw",e)});a(r)}return s("next")})}}function initSkinlib(){0!==$("#skinlib-container").length&&requestSkinlibData().then(function(e){renderSkinlib(e.items),updatePaginator($.skinlib.page,e.total_pages||1)})}function renderSkinlib(e){var t=$("#skinlib-container").html("");0===e.length?($("#skinlib-paginator").hide(),t.html('<p style="text-align: center; margin: 30px 0;">'+trans("general.noResult")+"</p>")):($("#skinlib-paginator").show(),t.html(e.reduce(function(e,t){return e+renderSkinlibItemComponent(t)},""))),$(".overlay").hide()}function requestSkinlibData(){return fetch({type:"GET",url:url("skinlib/data"),dataType:"json",data:$.skinlib,error:showAjaxError})}function renderSkinlibItemComponent(e){var t="",n="",r=e.liked?"liked":"";return void 0===e.liked?(t=trans("skinlib.anonymous"),n="anonymous"):t=e.liked?trans("skinlib.removeFromCloset"):trans("skinlib.addToCloset"),e.name=$.fn.dataTable.render.text().filter(e.name),'\n    <a href="'+url("skinlib/show/"+e.tid)+'">\n        <div class="item" tid="'+e.tid+'">\n            <div class="item-body">\n                <img src="'+url("preview/"+e.tid+".png")+'">\n            </div>\n\n            <div class="item-footer">\n                <p class="texture-name">\n                    <span title="'+e.name+'">'+e.name+"\n                        <small>"+trans("skinlib.filter."+e.type)+'</small>\n                    </span>\n                </p>\n\n                <span class="pull-right likes-count">'+e.likes+'</span>\n                <a title="'+t+'" class="more like '+r+" "+n+'" tid="'+e.tid+'" href="javascript:;" data-placement="top" data-toggle="tooltip"><i class="fa fa-heart"></i></a>\n\n                <small class="more private-label '+(0===e.public?"":"hide")+'" tid="'+e.tid+'">\n                    '+trans("skinlib.private")+"\n                </small>\n            </div>\n        </div>\n    </a>"}function updatePaginator(e,t){$.skinlib.page=e,$("p.pagination").text(trans("general.pagination",{page:e,total:t})),0===$("#skinlib-paginator").html().length?$("#skinlib-paginator").jqPaginator($.extend({},$.defaultPaginatorConfig,{currentPage:parseInt(e),totalPages:parseInt(t),onPageChange:onPageChange})):$("#skinlib-paginator").jqPaginator("option",{currentPage:parseInt(e),totalPages:parseInt(t)});for(var n=$("select.pagination").html(""),r=1;r<=t;r++)n.append('\n            <option value="'+r+'" '+(r===e?"selected":"")+">"+r+"</option>\n        ")}function updateFilter(e){e.preventDefault();var t=$(this).data("filter");"uploader"===t?($.skinlib.uploader=$(this).data("uid"),console.log("Show items uploaded by uid "+$.skinlib.uploader)):($.skinlib.filter=t,console.log("Filter by "+$.skinlib.filter)),reloadSkinlib()}function onPageChange(e,t){$.skinlib.page=e,updateBreadCrumb(),"init"===t?console.log("Init paginator",e):($(".overlay").show(),reloadSkinlib(),console.log("Rendering page",e))}function updateUrlQueryString(){var e=$.param($.skinlib);window.history.pushState(null,null,url("skinlib?"+e)),$("li.locale").each(function(){$(this).find("a").prop("href","?lang="+$(this).data("code")+"&"+e)})}function updateBreadCrumb(){"cape"===$.skinlib.filter?$("#filter-indicator").html(trans("general.cape")):$("#filter-indicator").html(trans("general.skin")+"<small>\n            "+trans("skinlib.filter."+$.skinlib.filter)+"\n        </small>"),0!==$.skinlib.uploader?$("#uploader-indicator").html(trans("skinlib.filter.uploader",{uid:$.skinlib.uploader})):$("#uploader-indicator").html(trans("skinlib.filter.allUsers")),$("#sort-indicator").html(trans("skinlib.sort."+$.skinlib.sort)),""!==$.skinlib.keyword&&($("#search-indicator").text(trans("general.searchResult",{keyword:decodeURI($.skinlib.keyword)})),$("#navbar-search-input").val(decodeURI($.skinlib.keyword)))}$.skinlib={page:getQueryString("page",1),filter:getQueryString("filter","skin"),sort:getQueryString("sort","time"),uploader:getQueryString("uploader",0),keyword:decodeURI(getQueryString("keyword",""))},$(document).ready(initSkinlib),$("body").on("change","select.pagination",function(){onPageChange(parseInt($(this).val()))}),$(".filter").click(updateFilter),$("body").on("click",".sort",function(e){e.preventDefault(),$.skinlib.sort=$(this).data("sort"),console.log("Sort by "+$.skinlib.sort),reloadSkinlib()}),$("body").on("submit","#search-form",function(e){e.preventDefault(),$.skinlib.keyword=$("#navbar-search-input").val(),console.log("Search keyword: "+$.skinlib.keyword),reloadSkinlib()});var ajaxAddToCloset=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var r,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return $(".modal").each(function(){return"none"===$(this).css("display")?$(this).remove():null}),e.prev=1,e.next=4,fetch({type:"POST",url:url("user/closet/add"),dataType:"json",data:{tid:t,name:n}});case 4:r=e.sent,a=r.errno,i=r.msg,0===a?(swal({type:"success",html:i}),$(".modal").modal("hide"),updateTextureStatus(t,"add")):toastr.warning(i),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),showAjaxError(e.t0);case 13:case"end":return e.stop()}},e,this,[[1,10]])}));return function(e,t){return n.apply(this,arguments)}}(),removeFromCloset=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,swal({text:trans("user.removeFromClosetNotice"),type:"warning",showCancelButton:!0,cancelButtonColor:"#3085d6",confirmButtonColor:"#d33"});case 3:e.next=8;break;case 5:return e.prev=5,e.t0=e.catch(0),e.abrupt("return");case 8:return e.prev=8,e.next=11,fetch({type:"POST",url:url("/user/closet/remove"),dataType:"json",data:{tid:t}});case 11:n=e.sent,r=n.errno,a=n.msg,0===r?(swal({type:"success",html:a}),updateTextureStatus(t,"remove")):toastr.warning(a),e.next=20;break;case 17:e.prev=17,e.t1=e.catch(8),showAjaxError(e.t1);case 20:case"end":return e.stop()}},e,this,[[0,5],[8,17]])}));return function(e){return t.apply(this,arguments)}}(),changeTextureName=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var r,a,i,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r="",e.prev=1,e.next=4,swal({text:trans("skinlib.setNewTextureName"),input:"text",inputValue:n,showCancelButton:!0,inputValidator:function(n){return new Promise(function(e,t){n?e():t(trans("skinlib.emptyNewTextureName"))})}});case 4:r=e.sent,e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(1),e.abrupt("return");case 10:return e.prev=10,e.next=13,fetch({type:"POST",url:url("skinlib/rename"),dataType:"json",data:{tid:t,new_name:r}});case 13:a=e.sent,i=a.errno,s=a.msg,0===i?($("#name").text(r),toastr.success(s)):toastr.warning(s),e.next=22;break;case 19:e.prev=19,e.t1=e.catch(10),showAjaxError(e.t1);case 22:case"end":return e.stop()}},e,this,[[1,7],[10,19]])}));return function(e,t){return n.apply(this,arguments)}}(),changeTextureModel=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var r,a,i,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={steve:"steve",alex:"alex",cape:trans("general.cape")},a="",e.prev=2,e.next=5,swal({text:trans("skinlib.setNewTextureModel"),input:"select",inputValue:n,inputOptions:r,showCancelButton:!0,inputClass:"form-control"});case 5:a=e.sent,e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return");case 11:return e.prev=11,e.next=14,fetch({type:"POST",url:url("skinlib/model"),dataType:"json",data:{tid:t,model:a}});case 14:i=e.sent,s=i.errno,o=i.msg,0===s?($("#model").text(r[a]),toastr.success(o)):toastr.warning(o),e.next=23;break;case 20:e.prev=20,e.t1=e.catch(11),showAjaxError(e.t1);case 23:case"end":return e.stop()}},e,this,[[2,8],[11,20]])}));return function(e,t){return n.apply(this,arguments)}}(),changePrivacy=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("skinlib/privacy"),dataType:"json",data:{tid:t}});case 3:n=e.sent,r=n.errno,a=n.msg,0===r?(toastr.success(a),"0"===n.public?$('a:contains("'+trans("skinlib.setAsPrivate")+'")').html(trans("skinlib.setAsPublic")):$('a:contains("'+trans("skinlib.setAsPublic")+'")').html(trans("skinlib.setAsPrivate"))):toastr.warning(a),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),showAjaxError(e.t0);case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(e){return t.apply(this,arguments)}}(),deleteTexture=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,swal({text:trans("skinlib.deleteNotice"),type:"warning",showCancelButton:!0});case 3:e.next=8;break;case 5:return e.prev=5,e.t0=e.catch(0),e.abrupt("return");case 8:return e.prev=8,e.next=11,fetch({type:"POST",url:url("skinlib/delete"),dataType:"json",data:{tid:t}});case 11:if(n=e.sent,r=n.errno,a=n.msg,0!==r){e.next=20;break}return e.next=17,swal({type:"success",html:a});case 17:window.location=url("skinlib"),e.next=21;break;case 20:swal({type:"warning",html:a});case 21:e.next=26;break;case 23:e.prev=23,e.t1=e.catch(8),showAjaxError(e.t1);case 26:case"end":return e.stop()}},e,this,[[0,5],[8,23]])}));return function(e){return t.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(a,i){function s(e,t){try{var n=o[e](t),r=n.value}catch(e){return void i(e)}if(!n.done)return Promise.resolve(r).then(function(e){s("next",e)},function(e){s("throw",e)});a(r)}return s("next")})}}function toggleLiked(){var e=$(this).attr("tid");$(this).hasClass("anonymous")||($(this).hasClass("liked")?removeFromCloset(e):addToCloset(e))}function addToCloset(a){var t,i=this;$.getJSON(url("skinlib/info/"+a),(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r=t.name;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,swal({title:trans("skinlib.setItemName"),text:trans("skinlib.applyNotice"),inputValue:r,input:"text",showCancelButton:!0,inputValidator:function(n){return new Promise(function(e,t){n?e():t(trans("skinlib.emptyItemName"))})}});case 3:n=e.sent,ajaxAddToCloset(a,n),e.next=9;break;case 7:e.prev=7,e.t0=e.catch(0);case 9:case"end":return e.stop()}},e,i,[[0,7]])})),function(e){return t.apply(this,arguments)}))}function updateTextureStatus(e,t){var n=$("#likes").length?$("#likes"):$(".item[tid="+e+"] .likes-count"),r=parseInt(n.html())+("add"===t?1:-1),a="add"===t?"removeFromCloset":"addToCloset";n.html(r),$("a.like[tid="+e+"]").attr("onclick",a+"("+e+");").attr("title",trans("skinlib."+a)).toggleClass("liked"),$(".btn#"+e).attr("onclick",a+"("+e+");").html(trans("skinlib."+a)),$("#quick-apply").toggle("add"===t)}function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(i,s){return function t(e,n){try{var r=o[e](n),a=r.value}catch(e){return void s(e)}if(!r.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});i(a)}("next")})}}function initUploadListeners(){"vendor.fileinput"!==trans("vendor.fileinput")&&($.fn.fileinputLocales[blessing.locale]=trans("vendor.fileinput")),$("body").on("change","#file",function(){return handleFiles()}).on("filebatchselected","#file",function(){return handleFiles()}).on("ifToggled","#type-cape",function(){return handleFiles()}).on("change","#skin-type",function(){0===$("#file").prop("files").length&&($.msp.viewer.skinUrl=getDefaultSkin()),$.msp.viewer.playerObject.skin.slim="alex"===$(this).val()}).on("ifToggled","#type-skin",function(){$(this).prop("checked")?$("#skin-type").show():$("#skin-type").hide()}).on("ifToggled","#private",function(){$(this).prop("checked")?$("#msg").show():$("#msg").hide()}),$(document).ready(function(){$.msp.config.skinUrl=defaultSteveSkin,initSkinViewer(),$('[for="private"]').tooltip()})}function handleFiles(e,r){if(e=e||$("#file").prop("files"),r=r||$("#type-cape").prop("checked")?"cape":"skin",0<e.length){var a=e[0];if("image/png"===a.type||"image/x-png"===a.type){var t=new FileReader;t.onload=function(){var n=new Image;n.onload=function(){var e=$("#name");if("cape"===r?($.msp.config.skinUrl=getDefaultSkin(),n.width/n.height==2?$.msp.config.capeUrl=n.src:($.msp.config.capeUrl=null,toastr.warning(trans("skinlib.badCapeSize")))):n.width===n.height||n.width/n.height==2?($.msp.config.skinUrl=n.src,$.msp.config.capeUrl=null,$.msp.config.slim=skinview3d.isSlimSkin(n),$("#skin-type").val($.msp.config.slim?"alex":"steve")):($.msp.config.skinUrl=getDefaultSkin(),toastr.warning(trans("skinlib.badSkinSize"))),initSkinViewer(),""===e.val()||e.val()===e.attr("data-last-file-name")){var t=a.name.replace(/\.[Pp][Nn][Gg]$/,"");e.attr("data-last-file-name",t),e.val(t)}},n.onerror=function(){return toastr.warning(trans("skinlib.fileExtError"))},n.src=this.result},t.readAsDataURL(a)}else toastr.warning(trans("skinlib.encodingError"))}}function getDefaultSkin(){return"alex"===$("#skin-type").val()?defaultAlexSkin:defaultSteveSkin}function upload(){var e,t,s=this,o=new FormData,n=$("#file").prop("files")[0];if(o.append("name",$("#name").val()),o.append("file",n),o.append("public",!$("#private").prop("checked")),$("#type-skin").prop("checked"))o.append("type",$("#skin-type").val());else{if(!$("#type-cape").prop("checked"))return toastr.info(trans("skinlib.emptyTextureType"));o.append("type","cape")}e=n,t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("skinlib/upload"),contentType:!1,dataType:"json",data:o,processData:!1,beforeSend:function(){$("#upload-button").html('<i class="fa fa-spinner fa-spin"></i> '+trans("skinlib.uploading")).prop("disabled","disabled")}});case 3:if(t=e.sent,n=t.errno,r=t.msg,a=t.tid,0!==n){e.next=12;break}i=function(){toastr.info(trans("skinlib.redirecting")),setTimeout(function(){window.location=url("skinlib/show/"+a)},1e3)},swal({type:"success",html:r}).then(i,i),e.next=15;break;case 12:return e.next=14,swal({type:"warning",html:r});case 14:$("#upload-button").html(trans("skinlib.upload")).prop("disabled","");case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(0),showAjaxError(e.t0),$("#upload-button").html(trans("skinlib.upload")).prop("disabled","");case 21:case"end":return e.stop()}},e,s,[[0,17]])})),void 0===e?(toastr.info(trans("skinlib.emptyUploadFile")),$("#file").focus()):""===$("#name").val()?(toastr.info(trans("skinlib.emptyTextureName")),$("#name").focus()):"image/png"!==e.type?(toastr.warning(trans("skinlib.fileExtError")),$("#file").focus()):t()}$(document).on("click",".more.like",toggleLiked),$(document).on("click",".private-label",_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,swal({text:trans("skinlib.setPublicNotice"),type:"warning",showCancelButton:!0});case 3:changePrivacy($(this).attr("tid")),$(this).remove(),e.next=9;break;case 7:e.prev=7,e.t0=e.catch(0);case 9:case"end":return e.stop()}},e,this,[[0,7]])})));