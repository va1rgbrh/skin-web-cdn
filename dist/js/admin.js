"use strict";var sendFeedback=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(""===document.cookie.replace(/(?:(?:^|.*;\s*)feedback_sent\s*=\s*([^;]*).*$)|^.*$/,"$1")){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,fetch({url:"https://work.prinzeugen.net/statistics/feedback",type:"POST",dataType:"json",data:{site_name:blessing.site_name,site_url:blessing.base_url,version:blessing.version},xhr:function(){var e=$.ajaxSettings.xhr(),t=e.setRequestHeader;return e.setRequestHeader=function(e,n){"X-CSRF-TOKEN"!==e&&t.call(this,e,n)},e}});case 5:n=e.sent,0===n.errno&&(document.cookie="feedback_sent="+Date.now(),console.log("Feedback sent. Thank you!")),e.next=12;break;case 10:e.prev=10,e.t0=e.catch(2);case 12:case"end":return e.stop()}},e,this,[[2,10]])}));return function(){return e.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(a,s){function i(e,n){try{var t=o[e](n),r=t.value}catch(e){return void s(e)}if(!t.done)return Promise.resolve(r).then(function(e){i("next",e)},function(e){i("throw",e)});a(r)}return i("next")})}}function handleDataTablesAjaxError(e,n,t,r){null===t&&showModal(r.responseText,trans("general.fatalError"),"danger")}$.extend(!0,$.fn.dataTable.defaults,{language:trans("vendor.datatables"),scrollX:!0,pageLength:25,autoWidth:!1,processing:!0,serverSide:!0}),$.fn.dataTable.ext.errMode="none";var submitColor=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("admin/customize?action=color"),dataType:"json",data:{color_scheme:current_skin}});case 3:n=e.sent,t=n.errno,r=n.msg,0===t?toastr.success(r):toastr.warning(r),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),showAjaxError(e.t0);case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(){return e.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(a,s){function i(e,n){try{var t=o[e](n),r=t.value}catch(e){return void s(e)}if(!t.done)return Promise.resolve(r).then(function(e){i("next",e)},function(e){i("throw",e)});a(r)}return i("next")})}}$("#layout-skins-list [data-skin]").click(function(e){e.preventDefault();var n=$(this).data("skin");$("body").removeClass(current_skin).addClass(n),current_skin=n}),$("#color-submit").click(submitColor);var installPlugin=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s,i,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=$("#plugin-"+n+" .btn"),r=t.html(),e.prev=2,e.next=5,fetch($.extend(!0,{type:"POST",url:url("admin/plugins/market/download"),dataType:"json",data:{name:n},beforeSend:function(){t.html('<i class="fa fa-spinner fa-spin"></i> '+trans("admin.pluginInstalling")).prop("disabled",!0)}},o));case 5:a=e.sent,s=a.errno,i=a.msg,0===s?(toastr.success(i),$.marketTable.ajax.reload(null,!1)):(t.html(r).prop("disabled",!1),swal({type:"warning",html:i})),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(2),t.html(r).prop("disabled",!1),showAjaxError(e.t0);case 15:case"end":return e.stop()}},e,this,[[2,11]])}));return function(e){return n.apply(this,arguments)}}(),updatePlugin=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!1!==(t=$.marketTable.row("#plugin-"+n).data()).installed){e.next=3;break}return e.abrupt("return",swal({type:"warning",html:"not installed"}));case 3:return e.prev=3,e.next=6,swal({text:trans("admin.confirmUpdate",{plugin:t.title,old:t.installed,new:t.version}),type:"warning",showCancelButton:!0});case 6:e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(3),e.abrupt("return");case 11:installPlugin(n,{beforeSend:function(){$("#plugin-"+n+" .btn").html('<i class="fa fa-refresh fa-spin"></i> '+trans("admin.pluginUpdating")).prop("disabled",!0)}});case 12:case"end":return e.stop()}},e,this,[[3,8]])}));return function(e){return n.apply(this,arguments)}}(),checkForPluginUpdates=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({url:url("admin/plugins/market/check")});case 3:!0===(n=e.sent).available&&(t='<span class="label label-success pull-right">'+n.plugins.length+"</span>",$('[href="'+url("admin/plugins/market")+'"]').append(t)),e.next=9;break;case 7:e.prev=7,e.t0=e.catch(0);case 9:case"end":return e.stop()}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(a,s){function i(e,n){try{var t=o[e](n),r=t.value}catch(e){return void s(e)}if(!t.done)return Promise.resolve(r).then(function(e){i("next",e)},function(e){i("throw",e)});a(r)}return i("next")})}}function initMarketTable(){$.marketTable=$("#market-table").DataTable({columnDefs:marketTableColumnDefs,ajax:{url:url("admin/plugins/market-data"),type:"POST"}}).on("xhr.dt",handleDataTablesAjaxError)}1===$("#market-table").length&&$(document).ready(initMarketTable);var marketTableColumnDefs=[{targets:0,title:trans("admin.pluginTitle"),data:"title",render:function(e,n,t){var r=$.fn.dataTable.render.text().filter;return"\n                <strong>"+r(e)+'</strong>\n                <div class="plugin-name">'+r(t.name)+"</div>\n            "}},{targets:1,title:trans("admin.pluginDescription"),data:"description",render:$.fn.dataTable.render.text(),orderable:!1},{targets:2,title:trans("admin.pluginAuthor"),data:"author",render:$.fn.dataTable.render.text(),orderable:!1},{targets:3,title:trans("admin.pluginVersion"),data:"version",render:$.fn.dataTable.render.text(),orderable:!1},{targets:4,title:trans("admin.pluginDependencies"),data:"dependencies",searchable:!1,orderable:!1,render:function(e){if(0===e.requirements.length)return"<i>"+trans("admin.noDependencies")+"</i>";var n="";for(var t in e.requirements){var r=e.requirements[t];n+='<span class="label bg-'+(t in e.unsatisfiedRequirements?"red":"green")+'">'+t+": "+r+"</span><br>"}return n}},{targets:5,title:trans("admin.pluginOperations"),orderable:!1,render:function(e,n,t){return t.installed?t.update_available?'\n                        <button class="btn btn-success btn-sm" onclick="updatePlugin(\''+t.name+'\');">\n                            <i class="fa fa-refresh" aria-hidden="true"></i> '+trans("admin.updatePlugin")+"\n                        </button>\n                    ":t.enabled?'\n                        <button class="btn btn-primary btn-sm" disabled>\n                            '+trans("admin.pluginEnabled")+"\n                        </button>\n                    ":'\n                    <button class="btn btn-primary btn-sm" onclick="enablePlugin(\''+t.name+'\');">\n                        <i class="fa fa-plug" aria-hidden="true"></i> '+trans("admin.enablePlugin")+"\n                    </button>\n                ":'\n                <button class="btn btn-default btn-sm" onclick="installPlugin(\''+t.name+'\');">\n                    <i class="fa fa-download" aria-hidden="true"></i> '+trans("admin.installPlugin")+"\n                </button>\n            "}}];var changePreference=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("admin/players?action=preference"),dataType:"json",data:{pid:$(this).parent().parent().attr("id"),preference:$(this).val()}});case 3:n=e.sent,t=n.errno,r=n.msg,0===t?toastr.success(r):toastr.warning(r),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),showAjaxError(e.t0);case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(){return e.apply(this,arguments)}}(),ajaxChangeTexture=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return $(".modal").each(function(){"none"===$(this).css("display")&&$(this).remove()}),t=$("#model").val(),r=$("#tid").val(),e.prev=3,e.next=6,fetch({type:"POST",url:url("admin/players?action=texture"),dataType:"json",data:{pid:n,model:t,tid:r}});case 6:a=e.sent,s=a.errno,i=a.msg,0===s?($("#"+n+"-"+t).attr("src",url("preview/64/"+r+".png")),$(".modal").modal("hide"),toastr.success(i)):toastr.warning(i),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(3),showAjaxError(e.t0);case 15:case"end":return e.stop()}},e,this,[[3,12]])}));return function(e){return n.apply(this,arguments)}}(),changePlayerName=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(n,t){var r,a,s,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=$("tr#"+n+" > td:nth-child(3)"),a=void 0,e.prev=2,e.next=5,swal({text:trans("admin.changePlayerNameNotice"),input:"text",inputValue:t,inputValidator:function(t){return new Promise(function(e,n){t?e():n(trans("admin.emptyPlayerName"))})}});case 5:a=e.sent,e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return");case 11:return e.prev=11,e.next=14,fetch({type:"POST",url:url("admin/players?action=name"),dataType:"json",data:{pid:n,name:a}});case 14:s=e.sent,i=s.errno,o=s.msg,0===i?(r.text(a),toastr.success(o)):toastr.warning(o),e.next=23;break;case 20:e.prev=20,e.t1=e.catch(11),showAjaxError(e.t1);case 23:case"end":return e.stop()}},e,this,[[2,8],[11,20]])}));return function(e,n){return t.apply(this,arguments)}}(),showNicknameInSwal=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=$(".swal2-input").val(),!(isNaN(n)||n<=0)){e.next=3;break}return e.abrupt("return");case 3:return e.prev=3,e.next=6,fetch({type:"GET",url:url("admin/user/"+n),dataType:"json"});case 6:t=e.sent,r=t.user,$(".swal2-content").html(trans("admin.changePlayerOwner")+'<small style="display: block; margin-top: .5em;">'+trans("admin.targetUser",{nickname:r.nickname})+"</small>"),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(3),$(".swal2-content").html("\n                    "+trans("admin.changePlayerOwner")+"<br>\n                    <small>"+trans("admin.noSuchUser")+"</small>\n                ");case 14:case"end":return e.stop()}},e,this,[[3,11]])}));return function(){return e.apply(this,arguments)}}(),deletePlayer=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,swal({text:trans("admin.deletePlayerNotice"),type:"warning",showCancelButton:!0});case 3:e.next=8;break;case 5:return e.prev=5,e.t0=e.catch(0),e.abrupt("return");case 8:return e.prev=8,e.next=11,fetch({type:"POST",url:url("admin/players?action=delete"),dataType:"json",data:{pid:n}});case 11:t=e.sent,r=t.errno,a=t.msg,0===r?($("tr#"+n).remove(),toastr.success(a)):toastr.warning(a),e.next=20;break;case 17:e.prev=17,e.t1=e.catch(8),showAjaxError(e.t1);case 20:case"end":return e.stop()}},e,this,[[0,5],[8,17]])}));return function(e){return n.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(a,s){function i(e,n){try{var t=o[e](n),r=t.value}catch(e){return void s(e)}if(!t.done)return Promise.resolve(r).then(function(e){i("next",e)},function(e){i("throw",e)});a(r)}return i("next")})}}function initPlayersTable(){var e=location.href.split("?")[1];$("#player-table").DataTable({columnDefs:playersTableColumnDefs,scrollY:.7*($(".content-wrapper").height()-$(".content-header").outerHeight()),fnDrawCallback:function(){return $('[data-toggle="tooltip"]').tooltip()},ajax:{url:url("admin/player-data"+(e?"?"+e:"")),type:"POST"}}).on("xhr.dt",handleDataTablesAjaxError)}1===$("#player-table").length&&$(document).ready(initPlayersTable);var playersTableColumnDefs=[{targets:0,data:"pid",width:"1%"},{targets:1,data:"uid",render:function(e,n,t){return'<a href="'+url("admin/users?uid="+t.uid)+'" title="'+trans("admin.inspectHisOwner")+'" data-toggle="tooltip" data-placement="right">'+e+"</span>"}},{targets:2,data:"player_name",render:$.fn.dataTable.render.text()},{targets:3,data:"preference",render:function(e){return'\n            <select class="form-control" onchange="changePreference.call(this)">\n                <option '+("default"===e?"selected=selected":"")+' value="default">Default (Steve)</option>\n                <option '+("slim"===e?"selected=selected":"")+' value="slim">Slim (Alex)</option>\n            </select>'}},{targets:4,searchable:!1,orderable:!1,render:function(e,n,a){return["steve","alex","cape"].reduce(function(e,n){var t=a["tid_"+n],r=a.pid+"-"+t;return 0===t?e+'<img id="'+r+'" width="64" />':e+'\n                <a href="'+url("skinlib/show/"+t)+'">\n                    <img id="'+r+'" width="64" src="'+url("/preview/64/"+t)+'.png" />\n                </a>'},"")}},{targets:5,data:"last_modified"},{targets:6,searchable:!1,orderable:!1,render:function(e,n,t){return'\n            <div class="btn-group">\n                <button type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n                    '+trans("admin.operationsTitle")+' <span class="caret"></span>\n                </button>\n                <ul class="dropdown-menu">\n                    <li><a style="cursor: pointer" onclick="changeTexture('+t.pid+", '"+t.player_name+"');\">"+trans("admin.changeTexture")+'</a></li>\n                    <li><a style="cursor: pointer" onclick="changePlayerName('+t.pid+", '"+t.player_name+"');\">"+trans("admin.changePlayerName")+'</a></li>\n                    <li><a style="cursor: pointer" onclick="changeOwner('+t.pid+');">'+trans("admin.changeOwner")+'</a></li>\n                </ul>\n            </div>\n            <a class="btn btn-danger btn-sm" style="cursor: pointer" onclick="deletePlayer('+t.pid+');">'+trans("admin.deletePlayer")+"</a>"}}];function changeTexture(e,n){var t='\n    <div class="form-group">\n        <label for="model">'+trans("admin.textureType")+'</label>\n        <select class="form-control" id="model">\n            <option value="steve">'+trans("admin.skin",{model:"Steve"})+'</option>\n            <option value="alex">'+trans("admin.skin",{model:"Alex"})+'</option>\n            <option value="cape">'+trans("admin.cape")+'</option>\n        </select>\n    </div>\n    <div class="form-group">\n        <label for="tid">'+trans("admin.pid")+'</label>\n        <input id="tid" class="form-control" type="text" placeholder="'+trans("admin.pidNotice")+'">\n    </div>';showModal(t,trans("admin.changePlayerTexture",{player:n}),"default",{callback:"ajaxChangeTexture("+e+")"})}function changeOwner(s){var n,i=this,o=$("#"+s+" > td:nth-child(2)"),c=0;swal({html:trans("admin.changePlayerOwner")+"<br><small>&nbsp;</small>",input:"number",inputValue:o.text(),showCancelButton:!0}).then((n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c=n,e.prev=1,e.next=4,fetch({type:"POST",url:url("admin/players?action=owner"),dataType:"json",data:{pid:s,uid:n}});case 4:t=e.sent,r=t.errno,a=t.msg,0===r?(o.text(c),toastr.success(a)):toastr.warning(a),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(1),showAjaxError(e.t0);case 13:case"end":return e.stop()}},e,i,[[1,10]])})),function(e){return n.apply(this,arguments)})),$(".swal2-input").on("input",debounce(showNicknameInSwal,350))}var enablePlugin=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=$.pluginsTable||$.marketTable,e.prev=1,0!==t.row("#plugin-"+n).data().dependencies.requirements.length){e.next=6;break}return e.next=6,swal({text:trans("admin.noDependenciesNotice"),type:"warning",showCancelButton:!0});case 6:return e.next=8,fetch({type:"POST",url:url("admin/plugins/manage?action=enable&name="+n),dataType:"json"});case 8:r=e.sent,a=r.errno,s=r.msg,i=r.reason,0===a?(toastr.success(s),t.ajax.reload(null,!1)):swal({type:"warning",html:"<p>"+s+"</p><ul><li>"+i.join("</li><li>")+"</li></ul>"}),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(1),showAjaxError(e.t0);case 18:case"end":return e.stop()}},e,this,[[1,15]])}));return function(e){return n.apply(this,arguments)}}(),disablePlugin=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("admin/plugins/manage?action=disable&name="+n),dataType:"json"});case 3:t=e.sent,r=t.errno,a=t.msg,0===r?(toastr.success(a),$.pluginsTable.ajax.reload(null,!1)):swal({type:"warning",html:a}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),showAjaxError(e.t0);case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(e){return n.apply(this,arguments)}}(),deletePlugin=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,swal({text:trans("admin.confirmDeletion"),type:"warning",showCancelButton:!0});case 3:e.next=8;break;case 5:return e.prev=5,e.t0=e.catch(0),e.abrupt("return");case 8:return e.prev=8,e.next=11,fetch({type:"POST",url:url("admin/plugins/manage?action=delete&name="+n),dataType:"json"});case 11:t=e.sent,r=t.errno,a=t.msg,0===r?(toastr.success(a),$.pluginsTable.ajax.reload(null,!1)):swal({type:"warning",html:a}),e.next=20;break;case 17:e.prev=17,e.t1=e.catch(8),showAjaxError(e.t1);case 20:case"end":return e.stop()}},e,this,[[0,5],[8,17]])}));return function(e){return n.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(a,s){function i(e,n){try{var t=o[e](n),r=t.value}catch(e){return void s(e)}if(!t.done)return Promise.resolve(r).then(function(e){i("next",e)},function(e){i("throw",e)});a(r)}return i("next")})}}function initPluginsTable(){$.pluginsTable=$("#plugin-table").DataTable({columnDefs:pluginsTableColumnDefs,fnDrawCallback:function(){return $('[data-toggle="tooltip"]').tooltip()},rowCallback:function(e,n){return $(e).addClass(n.enabled?"plugin-enabled":"")},ajax:{url:url("admin/plugins/data"),type:"POST"}}).on("xhr.dt",handleDataTablesAjaxError)}1===$("#plugin-table").length&&$(document).ready(initPluginsTable);var pluginsTableColumnDefs=[{targets:0,data:"title",title:trans("admin.pluginTitle"),width:"10%",render:function(e,n,t){var r=[];return t.enabled?(t.config&&r.push('<a href="'+url("admin/plugins/config/"+t.name)+'" class="text-primary">'+trans("admin.configurePlugin")+"</a>"),r.push("<a onclick=\"disablePlugin('"+t.name+'\');" class="text-primary">'+trans("admin.disablePlugin")+"</a>")):r.push("<a onclick=\"enablePlugin('"+t.name+'\');" class="text-primary">'+trans("admin.enablePlugin")+"</a>","<a onclick=\"deletePlugin('"+t.name+'\');" class="text-danger">'+trans("admin.deletePlugin")+"</a>"),"\n                <strong>"+$.fn.dataTable.render.text().filter(e)+'</strong>\n                <div class="actions">'+r.join(" | ")+"</div>\n            "}},{targets:1,data:"description",title:trans("admin.pluginDescription"),orderable:!1,render:function(e,n,t){return'\n                <div class="plugin-description"><p>'+$.fn.dataTable.render.text().filter(e)+'</p></div>\n                <div class="plugin-version-author">\n                    '+trans("admin.pluginVersion")+' <span class="text-primary">'+t.version+"</span> |\n                    "+trans("admin.pluginAuthor")+' <a href="'+t.url+'">'+t.author+"</a> |\n                    "+trans("admin.pluginName")+" <span>"+t.name+"</span>\n                </div>\n            "}},{targets:2,data:"dependencies",title:trans("admin.pluginDependencies"),searchable:!1,orderable:!1,render:function(e){if(0===e.requirements.length)return"<i>"+trans("admin.noDependencies")+"</i>";var n=e.isRequirementsSatisfied?"":'<a href="http://t.cn/RrT7SqC" target="_blank" class="label label-primary">'+trans("admin.whyDependencies")+"</a><br>";for(var t in e.requirements){var r=e.requirements[t];n+='<span class="label bg-'+(t in e.unsatisfiedRequirements?"red":"green")+'">'+t+": "+r+"</span><br>"}return n}}];var downloadUpdates=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Prepare to download"),n=void 0,e.prev=2,e.next=5,fetch({url:url("admin/update/download?action=prepare-download"),type:"GET",dataType:"json",beforeSend:function(){$("#update-button").html('<i class="fa fa-spinner fa-spin"></i> '+trans("admin.preparing")).prop("disabled",!0)}});case 5:return t=e.sent,console.log(t),$("#modal-start-download").modal({backdrop:"static",keyboard:!1}),console.log("Start downloading"),n=setInterval(progressPolling,1e3),e.next=12,fetch({url:url("admin/update/download?action=start-download"),type:"POST",dataType:"json"});case 12:return r=e.sent,clearInterval(n),console.log("Downloading finished"),console.log(r),$(".modal-title").html('<i class="fa fa-spinner fa-spin"></i> '+trans("admin.extracting")),$(".modal-body").append("<p>"+trans("admin.downloadCompleted")+"</p>"),console.log("Start extracting"),e.next=21,fetch({url:url("admin/update/download?action=extract"),type:"POST",dataType:"json"});case 21:a=e.sent,console.log("Package extracted and files are covered"),$("#modal-start-download").modal("toggle"),swal({type:"success",html:a.msg}).then(function(){window.location=url("/")},function(){window.location=url("/")}),e.next=31;break;case 27:e.prev=27,e.t0=e.catch(2),showAjaxError(e.t0),clearInterval(n);case 31:case"end":return e.stop()}},e,this,[[2,27]])}));return function(){return e.apply(this,arguments)}}(),progressPolling=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({url:url("admin/update/download?action=get-progress"),type:"GET"});case 3:if(n=e.sent,t=n.total,r=n.downloaded,void 0!==t){e.next=8;break}return e.abrupt("return");case 8:a=(r/t*100).toFixed(2),console.log("Download progress: "+r+"/"+t),$("#file-size").html(t),$("#download-progress").html(a),$(".progress-bar").css("width",a+"%").attr("aria-valuenow",a),e.next=17;break;case 15:e.prev=15,e.t0=e.catch(0);case 17:case"end":return e.stop()}},e,this,[[0,15]])}));return function(){return e.apply(this,arguments)}}(),checkForUpdates=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({url:url("admin/update/check")});case 3:!0===(n=e.sent).available&&(t='<span class="label label-primary pull-right">v'+n.latest+"</span>",$('[href="'+url("admin/update")+'"]').append(t)),e.next=9;break;case 7:e.prev=7,e.t0=e.catch(0);case 9:case"end":return e.stop()}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(a,s){function i(e,n){try{var t=o[e](n),r=t.value}catch(e){return void s(e)}if(!t.done)return Promise.resolve(r).then(function(e){i("next",e)},function(e){i("throw",e)});a(r)}return i("next")})}}var changeUserEmail=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=$("tr#user-"+n+" > td:nth-child(2)"),r="",e.prev=2,e.next=5,swal({text:trans("admin.newUserEmail"),showCancelButton:!0,input:"text",inputValue:t.text(),inputValidator:function(t){return new Promise(function(e,n){t?e():n(trans("auth.emptyEmail"))})}});case 5:r=e.sent,e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return");case 11:return e.prev=11,e.next=14,fetch({type:"POST",url:url("admin/users?action=email"),dataType:"json",data:{uid:n,email:r}});case 14:a=e.sent,s=a.errno,i=a.msg,0===s?(t.text(r),toastr.success(i)):toastr.warning(i),e.next=23;break;case 20:e.prev=20,e.t1=e.catch(11),showAjaxError(e.t1);case 23:case"end":return e.stop()}},e,this,[[2,8],[11,20]])}));return function(e){return n.apply(this,arguments)}}(),changeUserVerification=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("admin/users?action=verification"),dataType:"json",data:{uid:n}});case 3:t=e.sent,r=t.errno,a=t.msg,0===r?(s=$("#user-"+n+" > td.verification").text(),$("#user-"+n+" > td.verification").text(s===trans("admin.unverified")?trans("admin.verified"):trans("admin.unverified")),toastr.success(a)):toastr.warning(a),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),showAjaxError(e.t0);case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(e){return n.apply(this,arguments)}}(),changeUserNickName=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=$("tr#user-"+n+" > td:nth-child(3)"),r="",e.prev=2,e.next=5,swal({text:trans("admin.newUserNickname"),showCancelButton:!0,input:"text",inputValue:t.text(),inputValidator:function(t){return new Promise(function(e,n){t?e():n(trans("auth.emptyNickname"))})}});case 5:r=e.sent,e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return");case 11:return e.prev=11,e.next=14,fetch({type:"POST",url:url("admin/users?action=nickname"),dataType:"json",data:{uid:n,nickname:r}});case 14:a=e.sent,s=a.errno,i=a.msg,0===s?(t.text(r),toastr.success(i)):toastr.warning(i),e.next=23;break;case 20:e.prev=20,e.t1=e.catch(11),showAjaxError(e.t1);case 23:case"end":return e.stop()}},e,this,[[2,8],[11,20]])}));return function(e){return n.apply(this,arguments)}}(),changeUserPwd=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=void 0,e.prev=1,e.next=4,swal({text:trans("admin.newUserPassword"),showCancelButton:!0,input:"password"});case 4:t=e.sent,e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(1),e.abrupt("return");case 10:return e.prev=10,e.next=13,fetch({type:"POST",url:url("admin/users?action=password"),dataType:"json",data:{uid:n,password:t}});case 13:r=e.sent,a=r.errno,s=r.msg,0===a?toastr.success(s):toastr.warning(s),e.next=22;break;case 19:e.prev=19,e.t1=e.catch(10),showAjaxError(e.t1);case 22:case"end":return e.stop()}},e,this,[[1,7],[10,19]])}));return function(e){return n.apply(this,arguments)}}(),changeUserScore=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(n,t){var r,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("admin/users?action=score"),dataType:"json",data:{uid:n.slice(5),score:t}});case 3:r=e.sent,a=r.errno,s=r.msg,0===a?toastr.success(s):toastr.warning(s),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),showAjaxError(e.t0);case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(e,n){return t.apply(this,arguments)}}(),changeBanStatus=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("admin/users?action=ban"),dataType:"json",data:{uid:n}});case 3:t=e.sent,r=t.errno,a=t.msg,s=t.permission,0===r?("banned"===(i=$("#ban-"+n)).attr("data")?i.text(trans("admin.ban")).attr("data","normal"):i.text(trans("admin.unban")).attr("data","banned"),$("#user-"+n+" > td.status").text(-1===s?trans("admin.banned"):trans("admin.normal")),toastr.success(a)):toastr.warning(a),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),showAjaxError(e.t0);case 13:case"end":return e.stop()}},e,this,[[0,10]])}));return function(e){return n.apply(this,arguments)}}(),changeAdminStatus=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch({type:"POST",url:url("admin/users?action=admin"),dataType:"json",data:{uid:n}});case 3:t=e.sent,r=t.errno,a=t.msg,s=t.permission,0===r?("admin"===(i=$("#admin-"+n)).attr("data")?i.text(trans("admin.setAdmin")).attr("data","normal"):i.text(trans("admin.unsetAdmin")).attr("data","admin"),$("#user-"+n+" > td.status").text(1===s?trans("admin.admin"):trans("admin.normal")),toastr.success(a)):toastr.warning(a),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),showAjaxError(e.t0);case 13:case"end":return e.stop()}},e,this,[[0,10]])}));return function(e){return n.apply(this,arguments)}}(),deleteUserAccount=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,swal({text:trans("admin.deleteUserNotice"),type:"warning",showCancelButton:!0});case 3:e.next=8;break;case 5:return e.prev=5,e.t0=e.catch(0),e.abrupt("return");case 8:return e.prev=8,e.next=11,fetch({type:"POST",url:url("admin/users?action=delete"),dataType:"json",data:{uid:n}});case 11:t=e.sent,r=t.errno,a=t.msg,0===r?($("tr#user-"+n).remove(),toastr.success(a)):toastr.warning(a),e.next=20;break;case 17:e.prev=17,e.t1=e.catch(8),showAjaxError(e.t1);case 20:case"end":return e.stop()}},e,this,[[0,5],[8,17]])}));return function(e){return n.apply(this,arguments)}}();function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(s,i){return function n(e,t){try{var r=o[e](t),a=r.value}catch(e){return void i(e)}if(!r.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});s(a)}("next")})}}function initUsersTable(){var e=location.href.split("?")[1];$("#user-table").DataTable({columnDefs:usersTableColumnDefs,scrollY:.7*($(".content-wrapper").height()-$(".content-header").outerHeight()),fnDrawCallback:function(){return $('[data-toggle="tooltip"]').tooltip()},rowCallback:function(e,n){return $(e).attr("id","user-"+n.uid)},ajax:{url:url("admin/user-data"+(e?"?"+e:"")),type:"POST"}}).on("xhr.dt",handleDataTablesAjaxError)}1===$("#user-table").length&&$(document).ready(initUsersTable);var userPermissions={"-1":"banned",0:"normal",1:"admin",2:"superAdmin"},usersTableColumnDefs=[{targets:0,data:"uid",width:"1%"},{targets:1,data:"email"},{targets:2,data:"nickname",render:$.fn.dataTable.render.text()},{targets:3,data:"score",render:function(e){return'<input type="number" class="form-control score" value="'+e+'" title="'+trans("admin.scoreTip")+'" data-toggle="tooltip" data-placement="right">'}},{targets:4,data:"players_count",searchable:!1,orderable:!1,render:function(e,n,t){return'<a href="'+url("admin/players?uid="+t.uid)+'" title="'+trans("admin.inspectHisPlayers")+'" data-toggle="tooltip" data-placement="right">'+e+"</span>"}},{targets:5,data:"permission",className:"status",render:function(e){return trans("admin."+userPermissions[e])}},{targets:6,data:"verified",className:"verification",render:function(e){return trans("admin."+(e?"verified":"unverified"))}},{targets:7,data:"register_at"},{targets:8,data:"operations",searchable:!1,orderable:!1,render:renderUsersTableOperations}];function renderUsersTableOperations(e,n,t){var r="",a="",s=void 0;if(2!==t.permission){if(2===e){var i=1===t.permission?"admin":"normal";r='<li class="divider"></li> <li><a id="admin-'+t.uid+'" data="'+i+'" onclick="changeAdminStatus('+t.uid+');">\n                '+("admin"===i?trans("admin.unsetAdmin"):trans("admin.setAdmin"))+"\n            </a></li>"}var o=-1===t.permission?"banned":"normal";a='<li class="divider"></li> <li><a id="ban-'+t.uid+'" data="'+o+'" onclick="changeBanStatus('+t.uid+');">\n            '+("banned"===o?trans("admin.unban"):trans("admin.ban"))+"\n        </a></li>"}return s=2===e?2===t.permission?'<a class="btn btn-danger btn-sm" disabled="disabled" data-toggle="tooltip" data-placement="bottom" title="'+trans("admin.cannotDeleteSuperAdmin")+'">'+trans("admin.deleteUser")+"</a>":'<a class="btn btn-danger btn-sm" onclick="deleteUserAccount('+t.uid+');">'+trans("admin.deleteUser")+"</a>":1===t.permission||2===t.permission?'<a class="btn btn-danger btn-sm" disabled="disabled" data-toggle="tooltip" data-placement="bottom" title="'+trans("admin.cannotDeleteAdmin")+'">'+trans("admin.deleteUser")+"</a>":'<a class="btn btn-danger btn-sm" onclick="deleteUserAccount('+t.uid+');">'+trans("admin.deleteUser")+"</a>",'\n    <div class="btn-group">\n        <button type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n            '+trans("admin.operationsTitle")+' <span class="caret"></span>\n        </button>\n        <ul class="dropdown-menu">\n            <li><a onclick="changeUserEmail('+t.uid+');">'+trans("admin.changeEmail")+'</a></li>\n            <li><a onclick="changeUserVerification('+t.uid+');">'+trans("admin.changeVerification")+'</a></li>\n            <li><a onclick="changeUserNickName('+t.uid+');">'+trans("admin.changeNickName")+'</a></li>\n            <li><a onclick="changeUserPwd('+t.uid+');">'+trans("admin.changePassword")+"</a></li>\n            "+r+"\n            "+a+"\n        </ul>\n    </div>\n    "+s}$("body").on("keypress",".score",function(e){13===e.which&&($(this).blur(),changeUserScore($(this).parent().parent().attr("id"),$(this).val()))});